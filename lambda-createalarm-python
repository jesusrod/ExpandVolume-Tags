#======================================================
# Function: Create custom CW alarm from EC2 instace
#======================================================
import boto3
import datetime
import os
import time
from botocore.exceptions import ClientError

# Clients

cloudwatch = boto3.client('cloudwatch')
ec2 = boto3.resource('ec2')
ssm = boto3.client('ssm')
sns = boto3.client('sns')
client = boto3.client('ec2')
Email = os.environ.get('Email')

DEFAULT_TOPIC_NAME="CW-FreeDiskSpace"

def lambda_handler(event, context):

    sns_topic_arn = '' #defining this variable to get a new arn for every alarm

    if(event.get('detail') != None):
      detail = event.get('detail')
      instanceid_name = event["detail"]["instance-id"]
      if (detail.get('sns-topic')==None or detail['sns-topic']==''):
        print("No sns topic passed, creating SNS topic with default name.")
        
        # Let's review whether the instance has the EBSMAX tag added - otherwise we won't create alarm
        instancename = ''
        ec2instance = ec2.Instance(instanceid_name)
        for tags in ec2instance.tags:
            if tags["Key"] == 'ebsmax':
                instancename = tags["Value"]
                print ("Tag " + " exists, moving on")
                # Tag is found so we move on to configure alarm
                sns_topic_arn = get_sns_topic(DEFAULT_TOPIC_NAME,instanceid_name)
            else:
                return instancename, notag
                print("Instance is not tagged with ebsmax - not creating alarm")
            
    if (event.get('detail') == None or event['detail']['instance-id'] == ''):
        print("No instance id passed with the event.")
    else:
        instanceID = event["detail"]["instance-id"]
        print("installing and configuring Cloudwatch agents on the instance : " + instanceID)
        create_alarms(instanceID,sns_topic_arn)
 
def create_alarms(instanceID,sns_topic_arn):

  instance = ec2.Instance(instanceID)
  instanceIdlist = [instanceID]
  create_alarms_for_instance(instance, instance.id ,sns_topic_arn)
 
def install_and_configure_cwagent(instanceID):

    print('Instances to install Cloudwatch Agents:')
    print(instanceId)

    try:
        ssm.send_command(
            InstanceIds=instance_ids,
            DocumentName='AWS-RunPowerShellScript',
            Parameters={
                'commands': commands,
                'executionTimeout': ['600'] # Seconds all commands have to complete in
            })
        print('RunCommand sent successfully')
        return True

    except ClientError as err:
            if 'ThrottlingException' in str(err):
                print("RunCommand throttled, automatically retrying...")
                send_run_command(instance_ids, commands,os)
            else:
                print("Run Command Failed!\n%s", str(err))
                return False
 
def get_sns_topic(topicName,instanceid_name):

    topic = sns.create_topic(Name=topicName + '-' + instanceid_name)
    sns.subscribe(TopicArn=topic['TopicArn'], Protocol="email", Endpoint=Email)
    return (topic['TopicArn'])
 
def get_instance_type(instanceId):

  instance_type = ''
  response = client.describe_instances(InstanceIds=[instanceId,])
  instance_type = response['Reservations'][0]['Instances'][0]['InstanceType']
  return instance_type
 
def get_image_id(instanceId):

  image_id = ''
  response = client.describe_instances(InstanceIds=[instanceId,])
  image_id = response['Reservations'][0]['Instances'][0]['ImageId']
  return image_id

def create_alarms_for_instance(instance, instanceName,sns_topic_arn):

    instance_type = get_instance_type(instance.id)
    image_id = get_image_id(instance.id)
    cloudwatch.put_metric_alarm(AlarmName= instanceName + '- C:/ free disk space below 10%' ,
                      ComparisonOperator='LessThanThreshold',
                      EvaluationPeriods=1,
                      MetricName='LogicalDisk % Free Space',
                      Namespace='CWAgent',
                      Period=60,
                      Statistic='Average',
                      Threshold=10.0,
                      ActionsEnabled=False,
                      AlarmDescription='Alarm for disk space below 10% free',
                      TreatMissingData="notBreaching",
                      AlarmActions=[ sns_topic_arn ],
                      Dimensions=[
                          {
                            'Name': 'InstanceId',
                            'Value': instance.id
                          },
                          {
                            'Name':'instance',
                            'Value': 'C:'
                          },
                          {
                            'Name':'objectname',
                            'Value': 'LogicalDisk'
                          },
                          {
                            'Name': 'ImageId',
                            'Value': image_id
                          },
                          {
                            'Name': 'InstanceType',
                            'Value': instance_type
                          }
                      ],
                  )
    time.sleep(10)            

